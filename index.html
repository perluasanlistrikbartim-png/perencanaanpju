<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Web GIS Jaringan Listrik Bartim</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
/* ===============================
   GLOBAL
================================ */
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:#f4f6f8;
  color:#1f2937;
}

/* ===============================
   ANIMASI HALUS (DENYUT RINGAN)
================================ */
@keyframes softPulse{
  0%{
    box-shadow:0 0 0 rgba(244,196,48,0.0);
  }
  50%{
    box-shadow:0 0 12px rgba(244,196,48,0.35);
  }
  100%{
    box-shadow:0 0 0 rgba(244,196,48,0.0);
  }
}

@keyframes fadeSlide{
  from{
    opacity:0;
    transform:translateY(10px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* ===============================
   HEADER KOP SURAT (PUPR + PLN)
================================ */
header{
  position:fixed;
  top:0; left:0; right:0;
  background:#0f4c81; /* Biru PUPR */
  z-index:1000;
  border-bottom:4px solid #f4c430; /* Kuning PLN */
  animation:softPulse 6s ease-in-out infinite;
}

.header-top{
  display:flex;
  align-items:center;
  padding:10px 16px;
}

.header-logo{
  width:70px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.header-logo img{
  height:58px;
}

.header-title{
  flex:1;
  text-align:center;
  line-height:1.4;
  color:#ffffff;
}

.header-title .title-main{
  font-size:16px;
  font-weight:700;
  text-transform:uppercase;
}

.header-title .title-sub{
  font-size:13px;
  font-weight:500;
  opacity:.95;
}

/* ===============================
   BAR KONTROL
================================ */
.header-controls{
  display:flex;
  gap:10px;
  padding:8px 16px;
  background:#e9f1f8;
  border-top:1px solid rgba(255,255,255,0.3);
}

.header-controls select{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #cbd5e1;
  background:#ffffff;
  font-size:14px;
}

.header-controls button{
  padding:6px 14px;
  border-radius:6px;
  border:none;
  background:#f4c430;
  color:#1f2937;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
  animation:softPulse 5s ease-in-out infinite;
}

.header-controls button:hover{
  background:#e6b800;
  transform:translateY(-1px);
}

/* ===============================
   MAP
================================ */
#map{
  margin-top:150px;
  width:100%;
  height:60vh;
  z-index:1;
}

/* ===============================
   TABLE
================================ */
.table-wrapper{
  background:#ffffff;
  padding:12px;
  border-top:3px solid #0f4c81;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th, td{
  border:1px solid #e5e7eb;
  padding:6px 8px;
}

th{
  background:#f1f5f9;
  color:#0f4c81;
  font-weight:600;
}

/* ===============================
   POPUP OVERLAY
================================ */
#popup{
  position:fixed;
  top:160px;
  right:20px;
  width:340px;
  background:#ffffff;
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
  display:none;
  z-index:2000;
  animation:fadeSlide .25s ease-out;
}

.popup-head{
  background:#0f4c81;
  color:#ffffff;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:10px 10px 0 0;
}

.popup-body{
  padding:12px;
  font-size:14px;
}

.popup-body label{
  display:block;
  margin-top:8px;
}

.popup-body input,
.popup-body select{
  width:100%;
  padding:6px;
  margin-top:4px;
  border:1px solid #d1d5db;
  border-radius:6px;
}

/* ===============================
   RESPONSIVE
================================ */
@media(max-width:768px){
  .header-top{
    flex-direction:column;
    gap:6px;
  }

  .header-logo img{
    height:48px;
  }

  #map{
    height:50vh;
  }

  #popup{
    left:10px;
    right:10px;
    width:auto;
  }
}
/* =====================================================
   PATCH TABEL MOBILE & DESKTOP (AMAN, TIDAK EKSTRIM)
   MENIRU POLA SISTEM JEMBATAN
===================================================== */

/* WRAPPER TABEL BISA SCROLL */
.table-wrapper{
  overflow-x:auto;     /* SCROLL KIRI-KANAN */
  overflow-y:auto;
}

/* PAKSA TABEL LEBIH LEBAR DARI LAYAR */
.table-wrapper table{
  width:max-content;   /* ‚¨ÖÔ∏è KUNCI UTAMA */
  min-width:1200px;    /* sesuaikan jumlah kolom PJU */
}

/* JANGAN BIARKAN TEKS PECAH */
.table-wrapper th,
.table-wrapper td{
  white-space:nowrap;
}

/* HEADER TETAP TERLIHAT SAAT SCROLL */
.table-wrapper th{
  position:sticky;
  top:0;
  z-index:2;
}
/* =====================================================
   PATCH INTERAKSI TABEL ‚Üî MAP
===================================================== */
tr.active{
  background:#fde68a !important;
}

tr:hover{
  cursor:pointer;
  background:#fff7cc;
}

</style>

</head>

<body>

<header>
  <div class="header-top">
    <div class="header-logo">
      <img src="logo-bartim.png" alt="Logo Kabupaten Barito Timur">
      <!-- bisa juga: assets/img/logo-bartim.png -->
    </div>

    <div class="header-title">
      <div class="title-main">
        Sistem Informasi Perencanaan PJU pada Tiang Listrik PLN yang Belum Terpasang PJU
      </div>
      <div class="title-sub">
        Dinas Pekerjaan Umum, Penataan Ruang, Perumahan dan Kawasan Permukiman<br>
        Kabupaten Barito Timur
      </div>
    </div>
  </div>

  <div class="header-controls">
    <select id="kecamatanFilter">
      <option value="">-- Pilih Kecamatan --</option>
    </select>
    <button onclick="openInput()">+ Input Data</button>
  </div>
</header>

<div id="map"></div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-head">
    <span id="popupTitle">Judul</span>
    <span onclick="closePopup()" style="cursor:pointer">‚úñ</span>
  </div>
  <div class="popup-body" id="popupBody"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbyk8HcsTeNaVdPSb58pvFszIXD0szhorV9VX5xk5tW4PyZH1VF2x0EGVoaAhPGoPs2k/exec";

/* ================= MAP ================= */
const map = L.map('map',{minZoom:9,maxZoom:19})
  .setView([-1.95,115.15],10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const layer = L.layerGroup().addTo(map);

/* ================= ICON PLN ================= */
const plnIcon = L.icon({
  iconUrl:'assets/img/pln.png',
  iconSize:[36,36],
  iconAnchor:[18,18]
});

/* ================= GLOBAL STATE ================= */
let masterWilayah = [];
let markerMap = {};     // id_jaringan ‚Üí marker
let polylineMap = {};   // id_jaringan ‚Üí polyline
let tableMap = {};      // id_jaringan ‚Üí <tr>

/* ================= LOAD MASTER ================= */
fetch(API+'?action=master')
.then(r=>r.json())
.then(j=>{
  masterWilayah = j.data;
  const kec = [...new Set(j.data.map(d=>d.kecamatan))];
  const sel = document.getElementById('kecamatanFilter');
  kec.forEach(k=>{
    sel.innerHTML += `<option value="${k}">${k}</option>`;
  });
});

/* ================= FILTER KECAMATAN ================= */
document.getElementById('kecamatanFilter').onchange = ()=>{
  const kec = kecamatanFilter.value;
  layer.clearLayers();
  clearTable();
  closePopup();
  if(kec) loadDataByKecamatan(kec);
};

/* ================= LOAD DATA + RENDER ================= */
function loadDataByKecamatan(kecamatan){
  fetch(API+'?action=data&kecamatan='+encodeURIComponent(kecamatan))
  .then(r=>r.json())
  .then(j=>{
    renderTable(j.data);
    renderMap(j.data);
  });
}

/* ================= TABLE ================= */
function clearTable(){
  const tbody = document.querySelector('#tabelJaringan tbody');
  tbody.innerHTML = '';
  tableMap = {};
}

function renderTable(data){
  const tbody = document.querySelector('#tabelJaringan tbody');
  tbody.innerHTML = '';
  tableMap = {};

  data.forEach((d,i)=>{
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${d.kecamatan}</td>
      <td>${d.desa_kelurahan}</td>
      <td>${d.ruas_jalan}</td>
      <td>${d.jumlah_tiang}</td>
      <td>${d.panjang_jaringan || '-'}</td>
      <td>
        ${d.polyline_link ? `<a href="${d.polyline_link}" target="_blank">Track</a>` : '-'}
      </td>
    `;

    tr.onclick = ()=>{
      highlightRow(d.id_jaringan);
      zoomToPolyline(d.id_jaringan);
      openView(d);
    };

    tbody.appendChild(tr);
    tableMap[d.id_jaringan] = tr;
  });
}

/* ================= MAP ================= */
function renderMap(data){
  markerMap = {};
  polylineMap = {};

  data.forEach(d=>{
    if(d.lat && d.lng){
      const m = L.marker([d.lat,d.lng],{icon:plnIcon}).addTo(layer);
      markerMap[d.id_jaringan] = m;

      m.on('click',()=>{
        highlightRow(d.id_jaringan);
        openView(d);
      });
    }

    if(d.polyline_json){
      const pl = L.polyline(JSON.parse(d.polyline_json),{
        color:'#facc15',
        weight:4
      }).addTo(layer);

      polylineMap[d.id_jaringan] = pl;
    }
  });
}

/* ================= INTERAKSI ================= */
function highlightRow(id){
  Object.values(tableMap).forEach(tr=>tr.classList.remove('active'));
  if(tableMap[id]){
    tableMap[id].classList.add('active');
    tableMap[id].scrollIntoView({behavior:'smooth',block:'center'});
  }
}

function zoomToPolyline(id){
  if(polylineMap[id]){
    map.fitBounds(polylineMap[id].getBounds(),{padding:[40,40]});
  }else if(markerMap[id]){
    map.setView(markerMap[id].getLatLng(),15);
  }
}

/* ================= VIEW / EDIT PANEL (REUSE POPUP) ================= */
function openView(d){
  popupTitle.innerText = 'Detail Jaringan';

  popupBody.innerHTML = `
    <label>Kecamatan</label>
    <input value="${d.kecamatan}" readonly>

    <label>Desa / Kelurahan</label>
    <input value="${d.desa_kelurahan}" readonly>

    <label>Ruas Jalan</label>
    <input value="${d.ruas_jalan}" readonly>

    <label>Jumlah Tiang</label>
    <input value="${d.jumlah_tiang}" readonly>

    <label>Panjang Jaringan (km)</label>
    <input value="${d.panjang_jaringan || '-'}" readonly>

    <button onclick="openEdit(${d.id_jaringan})">‚úèÔ∏è Edit Data</button>
  `;
  openPopup();
}

function openEdit(id){
  fetch(API+'?action=detail&id='+id)
  .then(r=>r.json())
  .then(d=>{
    popupTitle.innerText = 'Edit Data Jaringan';

    popupBody.innerHTML = `
      <label>Ruas Jalan</label>
      <input id="e_ruas" value="${d.ruas_jalan}">

      <label>Jumlah Tiang</label>
      <input id="e_tiang" type="number" value="${d.jumlah_tiang}">

      <button onclick="saveEdit(${id})">üíæ Simpan Perubahan</button>
    `;
  });
}

function saveEdit(id){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'update',
      id_jaringan:id,
      ruas_jalan:e_ruas.value,
      jumlah_tiang:Number(e_tiang.value)
    })
  })
  .then(r=>r.json())
  .then(j=>{
    alert('‚úÖ Data diperbarui');
    closePopup();
    kecamatanFilter.onchange();
  });
}

/* ================= POPUP ================= */
function openPopup(){ popup.style.display='block'; }
function closePopup(){ popup.style.display='none'; }
</script>


</body>
</html>
