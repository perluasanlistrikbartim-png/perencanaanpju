<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Web GIS Jaringan Listrik Bartim</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
/* ===============================
   GLOBAL
================================ */
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:#f4f6f8;
  color:#1f2937;
}

/* ===============================
   ANIMASI HALUS
================================ */
@keyframes softPulse{
  0%{box-shadow:0 0 0 rgba(244,196,48,0)}
  50%{box-shadow:0 0 12px rgba(244,196,48,.35)}
  100%{box-shadow:0 0 0 rgba(244,196,48,0)}
}

@keyframes fadeSlide{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

/* ===============================
   HEADER ‚Äî PUPR
================================ */
header{
  position:fixed;
  top:0;left:0;right:0;
  background:#0f4c81;
  z-index:1000;
  border-bottom:4px solid #f4c430;
  animation:softPulse 6s ease-in-out infinite;
}

.header-top{
  display:flex;
  align-items:center;
  padding:10px 16px;
}

.header-logo{width:70px;display:flex;justify-content:center}
.header-logo img{height:58px}

.header-title{
  flex:1;
  text-align:center;
  color:#fff;
}
.header-title .title-main{
  font-size:16px;
  font-weight:700;
  text-transform:uppercase;
}
.header-title .title-sub{
  font-size:13px;
  opacity:.95;
}

/* ===============================
   BAR KONTROL
================================ */
.header-controls{
  display:flex;
  gap:10px;
  padding:8px 16px;
  background:#e9f1f8;
  border-top:1px solid rgba(255,255,255,.3);
}

.header-controls select{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #cbd5e1;
  background:#fff;
}

.header-controls button{
  padding:6px 14px;
  border-radius:6px;
  border:none;
  background:#f4c430;
  font-weight:600;
  cursor:pointer;
  animation:softPulse 5s ease-in-out infinite;
}
.header-controls button:hover{
  background:#e6b800;
  transform:translateY(-1px);
}

/* ===============================
   MAP
================================ */
#map{
  margin-top:150px;
  width:100%;
  height:60vh;
}

/* ===============================
   TABLE WRAPPER (KUNCI STABIL)
================================ */
.table-wrapper{
  background:#fff;
  padding:12px;
  border-top:3px solid #0f4c81;
  overflow-x:auto;
  overflow-y:auto;
}

/* scroll area */
.table-scroll{
  max-height:45vh;
  overflow-y:auto;
  overflow-x:auto;
}

/* ===============================
   TABLE (MENIRU SISTEM JEMBATAN)
================================ */
#tabelJaringan{
  width:max-content;
  min-width:1200px;
  border-collapse:collapse;
  font-size:13px;
}

#tabelJaringan th,
#tabelJaringan td{
  border:1px solid #e5e7eb;
  padding:8px 10px;
  white-space:nowrap;
}

/* header */
#tabelJaringan th{
  position:sticky;
  top:0;
  background:#f1f5f9;
  color:#0f4c81;
  font-weight:700;
  z-index:2;
}

/* hover */
#tabelJaringan tbody tr:hover{
  background:#fff7cc;
  cursor:pointer;
}

/* active (klik baris / marker) */
#tabelJaringan tr.active{
  background:#fde68a !important;
  font-weight:700;
  box-shadow:inset 4px 0 0 #f4c430;
}

/* ===============================
   POPUP PANEL (VIEW / INPUT / EDIT)
================================ */
#popup{
  position:fixed;
  top:160px;
  right:20px;
  width:340px;
  background:#fff;
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
  display:none;
  z-index:2000;
  animation:fadeSlide .25s ease-out;
}

.popup-head{
  background:#0f4c81;
  color:#fff;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:10px 10px 0 0;
}

.popup-body{
  padding:12px;
  font-size:14px;
}

.popup-body label{
  display:block;
  margin-top:8px;
  font-size:12px;
  color:#334155;
}

.popup-body input,
.popup-body select{
  width:100%;
  padding:6px;
  margin-top:4px;
  border:1px solid #d1d5db;
  border-radius:6px;
}

/* ===============================
   RESPONSIVE
================================ */
@media(max-width:768px){
  .header-top{flex-direction:column;gap:6px}
  .header-logo img{height:48px}
  #map{height:50vh}

  #popup{
    left:10px;
    right:10px;
    width:auto;
  }

  .table-scroll{
    max-height:40vh;
  }
}
</style>


</head>

<body>

<header>
  <div class="header-top">
    <div class="header-logo">
      <img src="logo-bartim.png" alt="Logo Kabupaten Barito Timur">
      <!-- bisa juga: logo-bartim.png -->
    </div>

    <div class="header-title">
      <div class="title-main">
        Sistem Informasi Perencanaan PJU pada Tiang Listrik PLN yang Belum Terpasang PJU
      </div>
      <div class="title-sub">
        Dinas Pekerjaan Umum, Penataan Ruang, Perumahan dan Kawasan Permukiman<br>
        Kabupaten Barito Timur
      </div>
    </div>
  </div>

  <div class="header-controls">
    <select id="kecamatanFilter">
      <option value="">-- Pilih Kecamatan --</option>
    </select>
    <button onclick="openInput()">+ Input Data</button>
  </div>
</header>

<div id="map"></div>
<div class="table-wrapper">
  <div class="table-scroll">
    <table id="tabelJaringan">
      <thead>
        <tr>
          <th>No</th>
          <th>Kecamatan</th>
          <th>Desa / Kelurahan</th>
          <th>Ruas Jalan</th>
          <th>Jumlah Tiang</th>
          <th>Panjang (km)</th>
          <th>Track</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-head">
    <span id="popupTitle">Judul</span>
    <span onclick="closePopup()" style="cursor:pointer">‚úñ</span>
  </div>
  <div class="popup-body" id="popupBody"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
   <script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbyk8HcsTeNaVdPSb58pvFszIXD0szhorV9VX5xk5tW4PyZH1VF2x0EGVoaAhPGoPs2k/exec";

/* ================= GLOBAL CACHE ================= */
let masterWilayah = [];
let dataJaringan = [];
let polylineCache = [];

/* ================= MODE ================= */
let modeForm = 'add';        // add | edit
let currentRow = null;      // data aktif

/* ================= MAP ================= */
const map = L.map('map',{minZoom:9,maxZoom:19})
  .setView([-1.95,115.15],10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const layer = L.layerGroup().addTo(map);

/* ================= ICON ================= */
const plnIcon = L.icon({
  iconUrl:'pln.png',
  iconSize:[36,36],
  iconAnchor:[18,18]
});

/* ================= DOM ================= */
const kecFilter  = document.getElementById('kecamatanFilter');
const popup      = document.getElementById('popup');
const popupTitle = document.getElementById('popupTitle');
const popupBody  = document.getElementById('popupBody');
const tbody      = document.querySelector('#tabelJaringan tbody');

/* ================= RELATION ================= */
const polylineMap = {};
const markerMap   = {};
const rowMap      = {};

/* ================= MASTER ================= */
fetch(API+'?action=master')
.then(r=>r.json())
.then(j=>{
  masterWilayah = j.data || [];
  [...new Set(masterWilayah.map(d=>d.kecamatan))].forEach(k=>{
    kecFilter.innerHTML += `<option value="${k}">${k}</option>`;
  });
});

/* ================= LOAD DATA ================= */
function loadAll(){
  Promise.all([
    fetch(API+'?action=data').then(r=>r.json()),
    fetch(API+'?action=polyline').then(r=>r.json())
  ]).then(([d,p])=>{
    dataJaringan   = d.data || [];
    polylineCache  = p.data || [];
    render();
  });
}

/* ================= RENDER ================= */
function render(){
  layer.clearLayers();
  tbody.innerHTML = '';
  Object.keys(polylineMap).forEach(k=>delete polylineMap[k]);
  Object.keys(markerMap).forEach(k=>delete markerMap[k]);
  Object.keys(rowMap).forEach(k=>delete rowMap[k]);

  let no = 1;
  const kec = kecFilter.value;

  polylineCache.forEach(pl=>{
    const row = dataJaringan.find(d=>d.id_jaringan===pl.id_jaringan);
    if(!row) return;
    if(kec && row.kecamatan!==kec) return;

    const coords = JSON.parse(pl.polyline_json || '[]');
    if(coords.length<2) return;

    const line = L.polyline(coords,{color:'#facc15',weight:4}).addTo(layer);
    polylineMap[row.id_jaringan] = line;

    const marker = L.marker(coords[Math.floor(coords.length/2)],{icon:plnIcon}).addTo(layer);
    marker.on('click', ()=>{
  setActive(row.id_jaringan);
  openView(row);
});
    markerMap[row.id_jaringan] = marker;

    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${no++}</td>
      <td>${row.kecamatan}</td>
      <td>${row.desa_kelurahan}</td>
      <td>${row.ruas_jalan}</td>
      <td>${row.jumlah_tiang}</td>
      <td>${row.panjang_jaringan}</td>
      <td><a target="_blank"
        href="https://www.google.com/maps/dir/${coords.map(c=>c[0]+','+c[1]).join('/')}">
        Buka
      </a></td>
    `;
    tbody.appendChild(tr);
    rowMap[row.id_jaringan] = tr;

    tr.onclick = ()=>{
      setActive(row.id_jaringan);
      map.fitBounds(line.getBounds(),{padding:[40,40]});
      openView(row);
    };

    line.on('click',()=>{
      setActive(row.id_jaringan);
      openView(row);
      tr.scrollIntoView({behavior:'smooth',block:'center'});
    });
  });
}

function setActive(id){
  Object.values(rowMap).forEach(r=>r.classList.remove('active'));
  if(rowMap[id]) rowMap[id].classList.add('active');
}

/* ================= VIEW ================= */
function openView(row){
  modeForm = 'edit';
  currentRow = row;

  popupTitle.innerText = 'Detail Data Jaringan';
  popupBody.innerHTML = `
    <label>Kecamatan</label>
    <input value="${row.kecamatan}" readonly>

    <label>Desa / Kelurahan</label>
    <input id="f_desa" value="${row.desa_kelurahan}">

    <label>Ruas Jalan</label>
    <input id="f_ruas" value="${row.ruas_jalan}">

    <label>Jumlah Tiang</label>
    <input id="f_tiang" type="number" value="${row.jumlah_tiang}">

    <label>Panjang</label>
    <input readonly value="${row.panjang_jaringan || '-'}">

    <button style="margin-top:12px" onclick="mintaEdit()">‚úèÔ∏è Edit</button>
  `;
  openPopup();
}

/* ================= EDIT ================= */
function mintaEdit(){
  const pin = prompt('Masukkan PIN Edit:');
  if(!pin) return; // validasi PIN nanti di GAS
  popupBody.innerHTML += `
    <button style="margin-top:10px" onclick="saveEdit()">üíæ Simpan Perubahan</button>
  `;
}

function saveEdit(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'update_data',
      payload:{
        id_jaringan:currentRow.id_jaringan,
        desa_kelurahan:document.getElementById('f_desa').value,
        ruas_jalan:document.getElementById('f_ruas').value,
        jumlah_tiang:Number(document.getElementById('f_tiang').value)
      }
    })
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=='OK'){ alert(j.message); return; }
    alert('‚úÖ Data diperbarui');
    closePopup();
    loadAll();
  });
}

/* ================= ADD ================= */
window.openInput = function(){
  popupTitle.innerText = 'Input Data Jaringan';
  popupBody.innerHTML = `
    <label>Kecamatan</label>
    <select id="f_kec" onchange="loadDesa()">
      <option value="">-- Pilih --</option>
      ${[...new Set(masterWilayah.map(d=>d.kecamatan))]
        .map(k=>`<option>${k}</option>`).join('')}
    </select>

    <label>Desa / Kelurahan</label>
    <select id="f_desa"></select>

    <label>Ruas Jalan</label>
    <input id="f_ruas">

    <label>Jumlah Tiang</label>
    <input id="f_tiang" type="number">

    <label>Upload Tracking (GPX)</label>
    <input id="f_file" type="file"
           accept=".gpx,application/gpx+xml">

    <button style="margin-top:12px" onclick="saveData()">Simpan</button>
  `;
  openPopup();
};

window.loadDesa = function(){
  const kec = document.getElementById('f_kec').value;
  const sel = document.getElementById('f_desa');
  sel.innerHTML = '<option value="">-- Pilih Desa --</option>';
  masterWilayah.filter(d=>d.kecamatan===kec)
    .forEach(d=>sel.innerHTML+=`<option>${d.desa_kelurahan}</option>`);
};

window.saveData = function(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'save_data',
      payload:{
        kecamatan:f_kec.value,
        desa_kelurahan:f_desa.value,
        ruas_jalan:f_ruas.value,
        jumlah_tiang:Number(f_tiang.value),
        kode_kecamatan:f_kec.value.substring(0,2).toUpperCase()
      }
    })
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=='OK'){ alert(j.message); return; }
    alert('‚úÖ Data tersimpan');
    closePopup();
    loadAll();
  });
};

/* ================= POPUP ================= */
window.openPopup  = ()=> popup.style.display='block';
window.closePopup = ()=> popup.style.display='none';

/* ================= FILTER ================= */
kecFilter.onchange = ()=>{ closePopup(); render(); };

/* ================= INIT ================= */
map.whenReady(loadAll);
</script>





</body>
</html>
