<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Web GIS Jaringan Listrik Bartim</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
/* ===============================
   GLOBAL
================================ */
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:#f4f6f8;
  color:#1f2937;
}

/* ===============================
   ANIMASI HALUS (DENYUT RINGAN)
================================ */
@keyframes softPulse{
  0%{
    box-shadow:0 0 0 rgba(244,196,48,0.0);
  }
  50%{
    box-shadow:0 0 12px rgba(244,196,48,0.35);
  }
  100%{
    box-shadow:0 0 0 rgba(244,196,48,0.0);
  }
}

@keyframes fadeSlide{
  from{
    opacity:0;
    transform:translateY(10px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* ===============================
   HEADER KOP SURAT (PUPR + PLN)
================================ */
header{
  position:fixed;
  top:0; left:0; right:0;
  background:#0f4c81; /* Biru PUPR */
  z-index:1000;
  border-bottom:4px solid #f4c430; /* Kuning PLN */
  animation:softPulse 6s ease-in-out infinite;
}

.header-top{
  display:flex;
  align-items:center;
  padding:10px 16px;
}

.header-logo{
  width:70px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.header-logo img{
  height:58px;
}

.header-title{
  flex:1;
  text-align:center;
  line-height:1.4;
  color:#ffffff;
}

.header-title .title-main{
  font-size:16px;
  font-weight:700;
  text-transform:uppercase;
}

.header-title .title-sub{
  font-size:13px;
  font-weight:500;
  opacity:.95;
}

/* ===============================
   BAR KONTROL
================================ */
.header-controls{
  display:flex;
  gap:10px;
  padding:8px 16px;
  background:#e9f1f8;
  border-top:1px solid rgba(255,255,255,0.3);
}

.header-controls select{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #cbd5e1;
  background:#ffffff;
  font-size:14px;
}

.header-controls button{
  padding:6px 14px;
  border-radius:6px;
  border:none;
  background:#f4c430;
  color:#1f2937;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
  animation:softPulse 5s ease-in-out infinite;
}

.header-controls button:hover{
  background:#e6b800;
  transform:translateY(-1px);
}

/* ===============================
   MAP
================================ */
#map{
  margin-top:150px;
  width:100%;
  height:60vh;
  z-index:1;
}

/* ===============================
   TABLE
================================ */
.table-wrapper{
  background:#ffffff;
  padding:12px;
  border-top:3px solid #0f4c81;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th, td{
  border:1px solid #e5e7eb;
  padding:6px 8px;
}

th{
  background:#f1f5f9;
  color:#0f4c81;
  font-weight:600;
}

/* ===============================
   POPUP OVERLAY
================================ */
#popup{
  position:fixed;
  top:160px;
  right:20px;
  width:340px;
  background:#ffffff;
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
  display:none;
  z-index:2000;
  animation:fadeSlide .25s ease-out;
}

.popup-head{
  background:#0f4c81;
  color:#ffffff;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:10px 10px 0 0;
}

.popup-body{
  padding:12px;
  font-size:14px;
}

.popup-body label{
  display:block;
  margin-top:8px;
}

.popup-body input,
.popup-body select{
  width:100%;
  padding:6px;
  margin-top:4px;
  border:1px solid #d1d5db;
  border-radius:6px;
}

/* ===============================
   RESPONSIVE
================================ */
@media(max-width:768px){
  .header-top{
    flex-direction:column;
    gap:6px;
  }

  .header-logo img{
    height:48px;
  }

  #map{
    height:50vh;
  }

  #popup{
    left:10px;
    right:10px;
    width:auto;
  }
}
</style>

</head>

<body>

<header>
  <div class="header-top">
    <div class="header-logo">
      <img src="logo-bartim.png" alt="Logo Kabupaten Barito Timur">
      <!-- bisa juga: assets/img/logo-bartim.png -->
    </div>

    <div class="header-title">
      <div class="title-main">
        Sistem Informasi Perencanaan PJU pada Tiang Listrik PLN yang Belum Terpasang PJU
      </div>
      <div class="title-sub">
        Dinas Pekerjaan Umum, Penataan Ruang, Perumahan dan Kawasan Permukiman<br>
        Kabupaten Barito Timur
      </div>
    </div>
  </div>

  <div class="header-controls">
    <select id="kecamatanFilter">
      <option value="">-- Pilih Kecamatan --</option>
    </select>
    <button onclick="openInput()">+ Input Data</button>
  </div>
</header>

<div id="map"></div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-head">
    <span id="popupTitle">Judul</span>
    <span onclick="closePopup()" style="cursor:pointer">✖</span>
  </div>
  <div class="popup-body" id="popupBody"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbyk8HcsTeNaVdPSb58pvFszIXD0szhorV9VX5xk5tW4PyZH1VF2x0EGVoaAhPGoPs2k/exec";

/* ================= MAP ================= */
const map = L.map('map',{minZoom:9,maxZoom:19})
  .setView([-1.95,115.15],10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const layer = L.layerGroup().addTo(map);

/* ================= ICON PLN ================= */
const plnIcon = L.icon({
  iconUrl:'assets/img/pln.png',
  iconSize:[36,36],
  iconAnchor:[18,18]
});

/* ================= MASTER WILAYAH ================= */
let masterWilayah = [];

fetch(API+'?action=master')
.then(r=>r.json())
.then(j=>{
  masterWilayah = j.data;
  const kec = [...new Set(j.data.map(d=>d.kecamatan))];
  const sel = document.getElementById('kecamatanFilter');
  kec.forEach(k=>{
    sel.innerHTML += `<option value="${k}">${k}</option>`;
  });
});

/* ================= FILTER (BELUM RENDER POLYLINE) ================= */
document.getElementById('kecamatanFilter').onchange = ()=>{
  layer.clearLayers();
  closePopup();
  // rendering data_jaringan + polyline akan ditambahkan tahap berikut
};

/* ================= INPUT FORM ================= */
function openInput(){
  document.getElementById('popupTitle').innerText = 'Input Data Jaringan';

  document.getElementById('popupBody').innerHTML = `
    <label>Kecamatan</label>
    <select id="f_kec" onchange="loadDesa()">
      <option value="">-- Pilih Kecamatan --</option>
      ${[...new Set(masterWilayah.map(d=>d.kecamatan))]
        .map(k=>`<option>${k}</option>`).join('')}
    </select>

    <label>Desa / Kelurahan</label>
    <select id="f_desa">
      <option value="">-- Pilih Desa --</option>
    </select>
   <label>Ruas Jalan</label>
   <input id="f_ruas" type="text" placeholder="Contoh: Tamiang Layang-Dorong">

    <label>Jumlah Tiang</label>
    <input id="f_tiang" type="number" min="0">

    <label>Panjang Jaringan (km)</label>
    <input value="otomatis dari tracking" readonly>

    <label>Upload Data Tracking</label>
    <input type="file" id="f_file" accept=".kml,.gpx,.geojson">
    <small>Upload aktif setelah data disimpan</small>

    <button style="margin-top:12px" onclick="saveData()">Simpan</button>
  `;
  openPopup();
}
function uploadTracking(idJaringan){
  const fileInput = document.getElementById('f_file');
  const file = fileInput.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = function(){
    const base64 = reader.result.split(',')[1];

    fetch(API,{
      method:'POST',
      body:JSON.stringify({
        action:'upload_tracking',
        id_jaringan:idJaringan,
        filename:file.name,
        mimeType:file.type || 'application/octet-stream',
        base64:base64
      })
    })
    .then(r=>r.json())
    .then(j=>{
      if(j.status==='OK'){
        alert('✅ Data & file berhasil disimpan');
      }else{
        alert('❌ '+j.message);
      }
    });
  };

  reader.readAsDataURL(file);
}

function loadDesa(){
  const kec = f_kec.value;
  const desa = masterWilayah
    .filter(d=>d.kecamatan===kec)
    .map(d=>d.desa_kelurahan);

  f_desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
  desa.forEach(d=>f_desa.innerHTML+=`<option>${d}</option>`);
}

/* ================= SAVE DATA ================= */
function saveData(){
  // ================= VALIDASI =================
  if(!f_kec.value || !f_desa.value || !f_ruas.value || !f_tiang.value){
    alert('Lengkapi Kecamatan, Desa/Kelurahan, Ruas Jalan, dan Jumlah Tiang');
    return;
  }

  const payload = {
    kecamatan      : f_kec.value,
    desa_kelurahan : f_desa.value,
    ruas_jalan     : f_ruas.value,
    jumlah_tiang   : Number(f_tiang.value),
    kode_kecamatan : f_kec.value.substring(0,2).toUpperCase()
  };

  // ================= KIRIM KE GAS =================
  fetch(API, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      action: 'save_data',
      payload: payload
    })
  })
  .then(res => {
    if(!res.ok) throw new Error('Gagal koneksi ke server');
    return res.json();
  })
  .then(j => {
    if(j.status !== 'OK'){
      alert('❌ ' + j.message);
      return;
    }

    const idJaringan = j.id_jaringan;

    // ================= UPLOAD TRACKING (OPSIONAL) =================
    const fileInput = document.getElementById('f_file');

    if(fileInput && fileInput.files.length > 0){
      uploadTracking(idJaringan); // upload GPX/KML
    } else {
      alert('✅ Data tersimpan\nID: ' + idJaringan);
    }

    closePopup();
  })
  .catch(err => {
    console.error(err);
    alert('❌ Terjadi kesalahan saat menyimpan data');
  });
}

/* ================= POPUP ================= */
function openPopup(){ popup.style.display='block'; }
function closePopup(){ popup.style.display='none'; }
</script>

</body>
</html>
