<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Web GIS Jaringan Listrik Bartim</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
/* ===============================
   GLOBAL
================================ */
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:#f4f6f8;
  color:#1f2937;
}

/* ===============================
   ANIMASI HALUS (DENYUT RINGAN)
================================ */
@keyframes softPulse{
  0%{
    box-shadow:0 0 0 rgba(244,196,48,0.0);
  }
  50%{
    box-shadow:0 0 12px rgba(244,196,48,0.35);
  }
  100%{
    box-shadow:0 0 0 rgba(244,196,48,0.0);
  }
}

@keyframes fadeSlide{
  from{
    opacity:0;
    transform:translateY(10px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* ===============================
   HEADER KOP SURAT (PUPR + PLN)
================================ */
header{
  position:fixed;
  top:0; left:0; right:0;
  background:#0f4c81; /* Biru PUPR */
  z-index:1000;
  border-bottom:4px solid #f4c430; /* Kuning PLN */
  animation:softPulse 6s ease-in-out infinite;
}

.header-top{
  display:flex;
  align-items:center;
  padding:10px 16px;
}

.header-logo{
  width:70px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.header-logo img{
  height:58px;
}

.header-title{
  flex:1;
  text-align:center;
  line-height:1.4;
  color:#ffffff;
}

.header-title .title-main{
  font-size:16px;
  font-weight:700;
  text-transform:uppercase;
}

.header-title .title-sub{
  font-size:13px;
  font-weight:500;
  opacity:.95;
}

/* ===============================
   BAR KONTROL
================================ */
.header-controls{
  display:flex;
  gap:10px;
  padding:8px 16px;
  background:#e9f1f8;
  border-top:1px solid rgba(255,255,255,0.3);
}

.header-controls select{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #cbd5e1;
  background:#ffffff;
  font-size:14px;
}

.header-controls button{
  padding:6px 14px;
  border-radius:6px;
  border:none;
  background:#f4c430;
  color:#1f2937;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
  animation:softPulse 5s ease-in-out infinite;
}

.header-controls button:hover{
  background:#e6b800;
  transform:translateY(-1px);
}

/* ===============================
   MAP
================================ */
#map{
  margin-top:150px;
  width:100%;
  height:60vh;
  z-index:1;
}

/* ===============================
   TABLE
================================ */
.table-wrapper{
  background:#ffffff;
  padding:12px;
  border-top:3px solid #0f4c81;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th, td{
  border:1px solid #e5e7eb;
  padding:6px 8px;
}

th{
  background:#f1f5f9;
  color:#0f4c81;
  font-weight:600;
}

/* ===============================
   POPUP OVERLAY
================================ */
#popup{
  position:fixed;
  top:160px;
  right:20px;
  width:340px;
  background:#ffffff;
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
  display:none;
  z-index:2000;
  animation:fadeSlide .25s ease-out;
}

.popup-head{
  background:#0f4c81;
  color:#ffffff;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:10px 10px 0 0;
}

.popup-body{
  padding:12px;
  font-size:14px;
}

.popup-body label{
  display:block;
  margin-top:8px;
}

.popup-body input,
.popup-body select{
  width:100%;
  padding:6px;
  margin-top:4px;
  border:1px solid #d1d5db;
  border-radius:6px;
}

/* ===============================
   RESPONSIVE
================================ */
@media(max-width:768px){
  .header-top{
    flex-direction:column;
    gap:6px;
  }

  .header-logo img{
    height:48px;
  }

  #map{
    height:50vh;
  }

  #popup{
    left:10px;
    right:10px;
    width:auto;
  }
}
</style>

</head>

<body>

<header>
  <div class="header-top">
    <div class="header-logo">
      <img src="logo-bartim.png" alt="Logo Kabupaten Barito Timur">
      <!-- bisa juga: assets/img/logo-bartim.png -->
    </div>

    <div class="header-title">
      <div class="title-main">
        Sistem Informasi Perencanaan PJU pada Tiang Listrik PLN yang Belum Terpasang PJU
      </div>
      <div class="title-sub">
        Dinas Pekerjaan Umum, Penataan Ruang, Perumahan dan Kawasan Permukiman<br>
        Kabupaten Barito Timur
      </div>
    </div>
  </div>

  <div class="header-controls">
    <select id="kecamatanFilter">
      <option value="">-- Pilih Kecamatan --</option>
    </select>
    <button onclick="openInput()">+ Input Data</button>
  </div>
</header>

<div id="map"></div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-head">
    <span id="popupTitle">Judul</span>
    <span onclick="closePopup()" style="cursor:pointer">✖</span>
  </div>
  <div class="popup-body" id="popupBody"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbyk8HcsTeNaVdPSb58pvFszIXD0szhorV9VX5xk5tW4PyZH1VF2x0EGVoaAhPGoPs2k/exec";

/* ================= GLOBAL CACHE ================= */
let dataJaringan = [];
let polylineCache = [];
let masterWilayah = [];

/* ================= MAP ================= */
const map = L.map('map',{minZoom:9,maxZoom:19})
  .setView([-1.95,115.15],10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const layer = L.layerGroup().addTo(map);

/* ================= ICON PLN ================= */
const plnIcon = L.icon({
  iconUrl:'assets/img/pln.png',
  iconSize:[36,36],
  iconAnchor:[18,18],
  popupAnchor:[0,-16]
});

/* ================= WARNA PER KECAMATAN (MUTED / DINAS) ================= */
const WARNA_KECAMATAN = {
  "Dusun Timur":        { main:"#6b7280", shadow:"#374151" },
  "Dusun Tengah":       { main:"#6b4f3f", shadow:"#3f2d20" },
  "Pematang Karau":     { main:"#556b2f", shadow:"#2f3b18" },
  "Raren Batuah":       { main:"#4b5563", shadow:"#1f2937" },
  "Paku":               { main:"#5f7161", shadow:"#37423d" },
  "Karusen Janang":     { main:"#7c6f64", shadow:"#3e342e" },
  "Awang":              { main:"#5b6770", shadow:"#2e3440" },
  "Paju Epat":          { main:"#6d5c45", shadow:"#3a2f21" },
  "Benua Lima":         { main:"#5a5f4b", shadow:"#2f3324" },
  "Patangkep Tutui":    { main:"#4a5d73", shadow:"#1f2937" }
};
const WARNA_DEFAULT = { main:"#6b7280", shadow:"#374151" };

/* ================= LOAD MASTER WILAYAH ================= */
fetch(API+'?action=master')
.then(r=>r.json())
.then(j=>{
  masterWilayah = j.data || [];
  const kec = [...new Set(masterWilayah.map(d=>d.kecamatan))];
  const sel = document.getElementById('kecamatanFilter');
  kec.forEach(k=>{
    sel.innerHTML += `<option value="${k}">${k}</option>`;
  });
});

/* ================= LOAD DATA JARINGAN + POLYLINE ================= */
function loadAllData(){
  Promise.all([
    fetch(API+'?action=data').then(r=>r.json()),
    fetch(API+'?action=polyline').then(r=>r.json())
  ]).then(([d,p])=>{
    dataJaringan  = d.data || [];
    polylineCache = p.data || [];

    console.log('DATA JARINGAN:', dataJaringan);
    console.log('POLYLINE CACHE:', polylineCache);
  });
}

/* ================= FILTER KECAMATAN ================= */
document.getElementById('kecamatanFilter').onchange = e=>{
  closePopup();
  renderPolylineByKecamatan(e.target.value);
};

/* ================= RENDER POLYLINE (FINAL FIX) ================= */
function renderPolylineByKecamatan(kecamatan){
  layer.clearLayers();
  if(!kecamatan) return; // ⛔ tidak tampil jika belum pilih

  const lines = [];
  const warna = WARNA_KECAMATAN[kecamatan] || WARNA_DEFAULT;

  polylineCache.forEach(pl=>{
    const row = dataJaringan.find(d=>d.id_jaringan===pl.id_jaringan);
    if(!row) return;
    if(row.kecamatan !== kecamatan) return;

    const coords = JSON.parse(pl.polyline_json);
    if(!coords || coords.length < 2) return;

    /* ===== SHADOW (EFEK 3D) ===== */
    L.polyline(coords,{
      color: warna.shadow,
      weight:10,
      opacity:0.85,
      lineCap:'round',
      lineJoin:'round'
    }).addTo(layer);

    /* ===== GARIS UTAMA ===== */
    const line = L.polyline(coords,{
      color: warna.main,
      weight:6,
      opacity:1,
      lineCap:'round',
      lineJoin:'round'
    }).addTo(layer);

    lines.push(line);

    /* ===== MARKER PLN DI TENGAH GARIS ===== */
    const midIndex = Math.floor(coords.length/2);
    const midPoint = coords[midIndex];

    L.marker(midPoint,{icon:plnIcon,zIndexOffset:1000})
      .bindPopup(`
        <b>Ruas Jalan</b><br>${row.ruas_jalan}<br><br>
        <b>Desa</b><br>${row.desa_kelurahan}<br><br>
        <b>Panjang</b><br>${row.panjang_km || '-'} km
      `)
      .addTo(layer);
  });

  if(lines.length){
    const group = L.featureGroup(lines);
    map.fitBounds(group.getBounds(), {padding:[40,40]});
  }
}

/* ================= INPUT FORM ================= */
function openInput(){
  document.getElementById('popupTitle').innerText = 'Input Data Jaringan';

  document.getElementById('popupBody').innerHTML = `
    <label>Kecamatan</label>
    <select id="f_kec" onchange="loadDesa()">
      <option value="">-- Pilih Kecamatan --</option>
      ${[...new Set(masterWilayah.map(d=>d.kecamatan))]
        .map(k=>`<option>${k}</option>`).join('')}
    </select>

    <label>Desa / Kelurahan</label>
    <select id="f_desa">
      <option value="">-- Pilih Desa --</option>
    </select>

    <label>Ruas Jalan</label>
    <input id="f_ruas" type="text">

    <label>Jumlah Tiang</label>
    <input id="f_tiang" type="number">

    <label>Panjang Jaringan (km)</label>
    <input value="otomatis dari tracking" readonly>

    <label>Upload Data Tracking</label>
    <input type="file" id="f_file" accept=".kml,.gpx,.geojson">

    <button style="margin-top:12px" onclick="saveData()">Simpan</button>
  `;
  openPopup();
}

/* ================= LOAD DESA ================= */
function loadDesa(){
  const kec = f_kec.value;
  const desa = masterWilayah
    .filter(d=>d.kecamatan===kec)
    .map(d=>d.desa_kelurahan);

  f_desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
  desa.forEach(d=>f_desa.innerHTML+=`<option>${d}</option>`);
}

/* ================= SAVE DATA ================= */
function saveData(){
  if(!f_kec.value || !f_desa.value || !f_ruas.value || !f_tiang.value){
    alert('Lengkapi semua field');
    return;
  }

  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'save_data',
      payload:{
        kecamatan:f_kec.value,
        desa_kelurahan:f_desa.value,
        ruas_jalan:f_ruas.value,
        jumlah_tiang:Number(f_tiang.value),
        kode_kecamatan:f_kec.value.substring(0,2).toUpperCase()
      }
    })
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=='OK'){
      alert(j.message); return;
    }

    const id = j.id_jaringan;
    const file = document.getElementById('f_file').files[0];
    if(!file){ alert('Data tersimpan'); closePopup(); return; }

    const fr = new FileReader();
    fr.onload = ()=>{
      fetch(API,{
        method:'POST',
        body:JSON.stringify({
          action:'upload_tracking',
          id_jaringan:id,
          filename:file.name,
          mimeType:file.type,
          base64:fr.result.split(',')[1]
        })
      }).then(()=>alert('Data & tracking tersimpan'));
    };
    fr.readAsDataURL(file);
    closePopup();
  });
}

/* ================= POPUP ================= */
function openPopup(){ popup.style.display='block'; }
function closePopup(){ popup.style.display='none'; }

/* ================= INIT ================= */
map.whenReady(()=>{
  loadAllData();
});
</script>



</body>
</html>
