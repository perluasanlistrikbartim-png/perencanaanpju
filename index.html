<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Web GIS Jaringan Listrik Bartim</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
/* ===============================
   GLOBAL
================================ */
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:#f4f6f8;
  color:#1f2937;
}

/* ===============================
   ANIMASI
================================ */
@keyframes softPulse{
  0%{box-shadow:0 0 0 rgba(244,196,48,0)}
  50%{box-shadow:0 0 12px rgba(244,196,48,.35)}
  100%{box-shadow:0 0 0 rgba(244,196,48,0)}
}

@keyframes fadeSlide{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

@keyframes kilatHeader{
  0%{left:-120%}
  40%{left:120%}
  100%{left:120%}
}

/* ===============================
   HEADER
================================ */
header{
  position:fixed;
  top:0;left:0;right:0;
  background:#0f4c81;
  z-index:1000;
  border-bottom:4px solid #f4c430;
  animation:softPulse 6s ease-in-out infinite;
}

.header-top{
  display:flex;
  align-items:center;
  padding:10px 16px;
}

.header-logo{
  width:70px;
  display:flex;
  justify-content:center;
}

.header-logo img{height:58px}

.header-title{
  flex:1;
  text-align:center;
  color:#fff;
}

.header-title .title-main{
  font-size:16px;
  font-weight:700;
  text-transform:uppercase;
}

.header-title .title-sub{
  font-size:13px;
  opacity:.95;
}

/* ===============================
   BAR KONTROL
================================ */
.header-controls{
  display:flex;
  gap:10px;
  padding:8px 16px;
  background:#e9f1f8;
}

.header-controls select,
.header-controls button{
  padding:6px 12px;
  border-radius:6px;
  font-size:14px;
}

.header-controls select{
  border:1px solid #cbd5e1;
}

.header-controls button{
  border:none;
  background:#f4c430;
  font-weight:600;
  cursor:pointer;
  animation:softPulse 5s ease-in-out infinite;
}

.header-controls button:hover{
  background:#e6b800;
  transform:translateY(-1px);
}

/* ===============================
   MAP
================================ */
#map{
  margin-top:150px;
  width:100%;
  height:60vh;
}

/* ===============================
   POPUP LEAFLET
================================ */
.leaflet-popup-content-wrapper{
  border-radius:10px;
  padding:0;
}

.popup-kecamatan-header{
  padding:8px 12px;
  color:#fff;
  font-weight:600;
  border-radius:10px 10px 0 0;
}

.popup-kecamatan-body{
  padding:10px 12px;
  font-size:13px;
}

.popup-kecamatan-body b{color:#374151}

/* ===============================
   ICON PLN 3D
================================ */
.icon-pln-3d{
  filter:
    drop-shadow(0 3px 3px rgba(0,0,0,.35))
    drop-shadow(0 6px 8px rgba(0,0,0,.25));
  transform:translateY(-1px);
}

.leaflet-marker-icon.icon-pln-3d:hover{
  transform:translateY(-2px) scale(1.05);
  filter:
    drop-shadow(0 4px 4px rgba(0,0,0,.4))
    drop-shadow(0 8px 12px rgba(0,0,0,.3));
}

/* ===============================
   TABEL GIS PREMIUM
================================ */
.table-wrapper{
  background:linear-gradient(180deg,#0f4c81,#0b355c);
  padding:14px;
  border-radius:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.25);
  overflow-x:auto;
}

#tabelJaringan{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  background:#fff;
  border-radius:10px;
  overflow:hidden;
  font-size:13px;
}

#tabelJaringan thead th{
  background:linear-gradient(180deg,#1e6091,#0f4c81);
  color:#e6f4ff;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.05em;
  padding:10px 8px;
  position:relative;
  border-bottom:2px solid #f4c430;
}

#tabelJaringan thead th::after{
  content:"";
  position:absolute;
  top:0;
  left:-120%;
  width:120%;
  height:100%;
  background:linear-gradient(
    120deg,
    transparent,
    rgba(244,196,48,.35),
    transparent
  );
  animation:kilatHeader 7s linear infinite;
}

#tabelJaringan tbody td{
  padding:9px 10px;
  border-bottom:1px solid #e5e7eb;
}

#tabelJaringan tbody tr{
  transition:.2s ease;
  cursor:pointer;
}

#tabelJaringan tbody tr:hover{
  background:linear-gradient(90deg,#fef9c3,#fff);
  box-shadow:inset 4px 0 0 #f4c430;
}

#tabelJaringan tbody tr.active{
  background:linear-gradient(90deg,#fde68a,#fffbea);
  font-weight:600;
  box-shadow:
    inset 5px 0 0 #f4c430,
    0 0 14px rgba(244,196,48,.45);
}

#tabelJaringan td:first-child{
  text-align:center;
  font-weight:700;
  color:#0f4c81;
}

#tabelJaringan a{
  padding:4px 8px;
  border-radius:6px;
  background:linear-gradient(180deg,#e0f2fe,#bae6fd);
  color:#075985;
  font-weight:600;
  text-decoration:none;
}

#tabelJaringan a:hover{
  background:linear-gradient(180deg,#bae6fd,#7dd3fc);
  box-shadow:0 0 10px rgba(56,189,248,.6);
}

/* ===============================
   RESPONSIVE HP
================================ */
@media(max-width:768px){
  #map{height:50vh}

  #tabelJaringan thead{display:none}

  #tabelJaringan tbody tr{
    display:block;
    margin-bottom:10px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,.15);
  }

  #tabelJaringan tbody td{
    display:flex;
    justify-content:space-between;
    border:none;
    border-bottom:1px solid #e5e7eb;
  }

  #tabelJaringan tbody td::before{
    content:attr(data-label);
    font-weight:600;
    color:#0f4c81;
  }
}
</style>


</head>

<body>

<header>
  <div class="header-top">
    <div class="header-logo">
      <img src="logo-bartim.png" alt="Logo Kabupaten Barito Timur">
      <!-- bisa juga: assets/img/logo-bartim.png -->
    </div>

    <div class="header-title">
      <div class="title-main">
        Sistem Informasi Perencanaan PJU pada Tiang Listrik PLN yang Belum Terpasang PJU
      </div>
      <div class="title-sub">
        Dinas Pekerjaan Umum, Penataan Ruang, Perumahan dan Kawasan Permukiman<br>
        Kabupaten Barito Timur
      </div>
    </div>
  </div>

  <div class="header-controls">
    <select id="kecamatanFilter">
      <option value="">-- Pilih Kecamatan --</option>
    </select>
    <button onclick="openInput()">+ Input Data</button>
  </div>
</header>

<div id="map"></div>
<div class="table-wrapper">
  <table id="tabelJaringan">
    <thead>
      <tr>
        <th>No</th>
        <th>Kecamatan</th>
        <th>Desa / Kelurahan</th>
        <th>Ruas Jalan</th>
        <th>Jumlah Tiang</th>
        <th>Panjang (km)</th>
        <th>Track</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-head">
    <span id="popupTitle">Judul</span>
    <span onclick="closePopup()" style="cursor:pointer">✖</span>
  </div>
  <div class="popup-body" id="popupBody"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbyk8HcsTeNaVdPSb58pvFszIXD0szhorV9VX5xk5tW4PyZH1VF2x0EGVoaAhPGoPs2k/exec";

/* ================= GLOBAL CACHE ================= */
let dataJaringan = [];
let polylineCache = [];
let masterWilayah = [];

/* ================= MAP ================= */
const map = L.map('map',{minZoom:9,maxZoom:19})
  .setView([-1.95,115.15],10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const layer = L.layerGroup().addTo(map);

/* ================= ICON PLN ================= */
const plnIcon = L.icon({
  iconUrl:'pln.png',
  iconSize:[36,36],
  iconAnchor:[18,18],
  popupAnchor:[0,-16],
  className:'icon-pln-3d'
});


/* ================= WARNA PER KECAMATAN (MUTED / DINAS) ================= */
const WARNA_KECAMATAN = {
  "Dusun Timur":        { main:"#6b7280", shadow:"#374151" },
  "Dusun Tengah":       { main:"#6b4f3f", shadow:"#3f2d20" },
  "Pematang Karau":     { main:"#556b2f", shadow:"#2f3b18" },
  "Raren Batuah":       { main:"#4b5563", shadow:"#1f2937" },
  "Paku":               { main:"#5f7161", shadow:"#37423d" },
  "Karusen Janang":     { main:"#7c6f64", shadow:"#3e342e" },
  "Awang":              { main:"#5b6770", shadow:"#2e3440" },
  "Paju Epat":          { main:"#6d5c45", shadow:"#3a2f21" },
  "Benua Lima":         { main:"#5a5f4b", shadow:"#2f3324" },
  "Patangkep Tutui":    { main:"#4a5d73", shadow:"#1f2937" }
};
const WARNA_DEFAULT = { main:"#6b7280", shadow:"#374151" };

/* ================= LOAD MASTER WILAYAH ================= */
fetch(API+'?action=master')
.then(r=>r.json())
.then(j=>{
  masterWilayah = j.data || [];
  const kec = [...new Set(masterWilayah.map(d=>d.kecamatan))];
  const sel = document.getElementById('kecamatanFilter');
  kec.forEach(k=>{
    sel.innerHTML += `<option value="${k}">${k}</option>`;
  });
});

/* ================= LOAD DATA JARINGAN + POLYLINE ================= */
function loadAllData(){
  Promise.all([
    fetch(API+'?action=data').then(r=>r.json()),
    fetch(API+'?action=polyline').then(r=>r.json())
  ]).then(([d,p])=>{
    dataJaringan  = d.data || [];
    polylineCache = p.data || [];

    console.log('DATA JARINGAN:', dataJaringan);
    console.log('POLYLINE CACHE:', polylineCache);
  });
}

/* ================= FILTER KECAMATAN ================= */
document.getElementById('kecamatanFilter').onchange = e=>{
  closePopup();
  renderPolylineByKecamatan(e.target.value);
};
let mapObjects = {}; 
// { id_jaringan : { line, marker, rowEl } }

/* ================= RENDER POLYLINE (FINAL FIX) ================= */
function renderPolylineByKecamatan(kecamatan){
  layer.clearLayers();
  mapObjects = {};

  const tbody = document.querySelector('#tabelJaringan tbody');
  if(tbody) tbody.innerHTML = '';

  let nomor = 1;

  polylineCache.forEach(pl=>{
    const row = dataJaringan.find(d=>d.id_jaringan===pl.id_jaringan);
    if(!row) return;

    // filter kecamatan (kalau kosong = semua)
    if(kecamatan && row.kecamatan !== kecamatan) return;

    const coords = JSON.parse(pl.polyline_json);
    if(!coords || coords.length < 2) return;

    const warna = WARNA_KECAMATAN[row.kecamatan] || WARNA_DEFAULT;

    /* ===== SHADOW (EFEK 3D) ===== */
    L.polyline(coords,{
      color: warna.shadow,
      weight:10,
      opacity:0.85,
      lineCap:'round',
      lineJoin:'round'
    }).addTo(layer);

    /* ===== GARIS UTAMA ===== */
    const line = L.polyline(coords,{
      color: warna.main,
      weight:6,
      opacity:1,
      lineCap:'round',
      lineJoin:'round'
    }).addTo(layer);

    /* ===== MARKER PLN ===== */
    const midPoint = coords[Math.floor(coords.length/2)];
    const marker = L.marker(midPoint,{
      icon:plnIcon,
      zIndexOffset:1000
    })
    .bindPopup(`
      <div class="popup-kecamatan-header"
           style="background:${warna.main};border-bottom:3px solid ${warna.shadow}">
        ${row.kecamatan}
      </div>

      <div class="popup-kecamatan-body">
        <b>Ruas Jalan</b><br>${row.ruas_jalan}<br><br>
        <b>Desa</b><br>${row.desa_kelurahan}<br><br>
        <b>Jumlah Tiang</b><br>${row.jumlah_tiang || '-'}<br><br>
        <b>Panjang</b><br>${row.panjang_jaringan || '-'} km
      </div>
    `)
    .addTo(layer);

    /* ===== SIMPAN RELASI MAP ↔ TABEL ===== */
    mapObjects[row.id_jaringan] = { line, marker };

    /* ===== ISI TABEL ===== */
    if(tbody){
      const gmapLink =
        'https://www.google.com/maps/dir/' +
        coords.map(c=>`${c[0]},${c[1]}`).join('/');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${nomor++}</td>
        <td>${row.kecamatan}</td>
        <td>${row.desa_kelurahan}</td>
        <td>${row.ruas_jalan}</td>
        <td>${row.jumlah_tiang}</td>
        <td>${row.panjang_jaringan}</td>
        <td><a href="${gmapLink}" target="_blank">Buka</a></td>
      `;

      tr.onclick = ()=>{
        resetHighlight();
        tr.classList.add('active');
        line.setStyle({ color:'#dc2626', weight:8 });
        marker.openPopup();
        map.panTo(marker.getLatLng());
      };

      marker.on('click',()=>{
        resetHighlight();
        tr.classList.add('active');
        line.setStyle({ color:'#dc2626', weight:8 });
        tr.scrollIntoView({behavior:'smooth', block:'center'});
      });

      tbody.appendChild(tr);
    }
  });

  if(Object.keys(mapObjects).length){
    const bounds = L.featureGroup(
      Object.values(mapObjects).map(o=>o.line)
    ).getBounds();
    map.fitBounds(bounds,{padding:[40,40]});
  }
}
/* ================= RESET SOROT (WAJIB DI LUAR) ================= */
function resetHighlight(){
  Object.values(mapObjects).forEach(o=>{
    const kec = o.rowEl
      ? o.rowEl.children[1].innerText
      : null;

    const warna = WARNA_KECAMATAN[kec] || WARNA_DEFAULT;

    o.line.setStyle({
      color: warna.main,
      weight: 6
    });

    if(o.rowEl){
      o.rowEl.classList.remove('active');
    }
  });
}



/* ================= INPUT FORM ================= */
function openInput(){
  document.getElementById('popupTitle').innerText = 'Input Data Jaringan';

  document.getElementById('popupBody').innerHTML = `
    <label>Kecamatan</label>
    <select id="f_kec" onchange="loadDesa()">
      <option value="">-- Pilih Kecamatan --</option>
      ${[...new Set(masterWilayah.map(d=>d.kecamatan))]
        .map(k=>`<option>${k}</option>`).join('')}
    </select>

    <label>Desa / Kelurahan</label>
    <select id="f_desa">
      <option value="">-- Pilih Desa --</option>
    </select>

    <label>Ruas Jalan</label>
    <input id="f_ruas" type="text">

    <label>Jumlah Tiang</label>
    <input id="f_tiang" type="number">

    <label>Panjang Jaringan (km)</label>
    <input value="otomatis dari tracking" readonly>

    <label>Upload Data Tracking</label>
    <input type="file" id="f_file" accept=".kml,.gpx,.geojson">

    <button style="margin-top:12px" onclick="saveData()">Simpan</button>
  `;
  openPopup();
}

/* ================= LOAD DESA ================= */
function loadDesa(){
  const kec = f_kec.value;
  const desa = masterWilayah
    .filter(d=>d.kecamatan===kec)
    .map(d=>d.desa_kelurahan);

  f_desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
  desa.forEach(d=>f_desa.innerHTML+=`<option>${d}</option>`);
}

/* ================= SAVE DATA ================= */
function saveData(){
  if(!f_kec.value || !f_desa.value || !f_ruas.value || !f_tiang.value){
    alert('Lengkapi semua field');
    return;
  }

  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'save_data',
      payload:{
        kecamatan:f_kec.value,
        desa_kelurahan:f_desa.value,
        ruas_jalan:f_ruas.value,
        jumlah_tiang:Number(f_tiang.value),
        kode_kecamatan:f_kec.value.substring(0,2).toUpperCase()
      }
    })
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=='OK'){
      alert(j.message); return;
    }

    const id = j.id_jaringan;
    const file = document.getElementById('f_file').files[0];
    if(!file){ alert('Data tersimpan'); closePopup(); return; }

    const fr = new FileReader();
    fr.onload = ()=>{
      fetch(API,{
        method:'POST',
        body:JSON.stringify({
          action:'upload_tracking',
          id_jaringan:id,
          filename:file.name,
          mimeType:file.type,
          base64:fr.result.split(',')[1]
        })
      }).then(()=>alert('Data & tracking tersimpan'));
    };
    fr.readAsDataURL(file);
    closePopup();
  });
}

/* ================= POPUP ================= */
function openPopup(){ popup.style.display='block'; }
function closePopup(){ popup.style.display='none'; }

/* ================= INIT ================= */
map.whenReady(()=>{
  loadAllData();
});
</script>



</body>
</html>
