<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Web GIS Jaringan Listrik Bartim</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Segoe UI,Arial;background:#f4f6f8}
header{position:fixed;top:0;left:0;right:0;background:#fff;z-index:1000;border-bottom:2px solid #ddd}
.header-top{display:flex;align-items:center;padding:6px 12px}
.header-top img{height:42px}
.header-title{flex:1;text-align:center}
.header-controls{display:flex;gap:10px;padding:6px 12px;background:#f9fafb}
select,button{padding:6px 10px;border-radius:6px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
#map{position:absolute;top:130px;left:0;right:0;bottom:0}
#popup{position:fixed;top:150px;right:20px;width:320px;background:#fff;
border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.2);
display:none;z-index:2000}
.popup-head{background:#2563eb;color:#fff;padding:10px;
display:flex;justify-content:space-between}
.popup-body{padding:12px;font-size:14px}
.popup-body input{width:100%;padding:6px;margin-top:4px}
</style>
</head>

<body>

<header>
  <div class="header-top">
    <img src="assets/img/logo-bartim.png">
    <div class="header-title">
      <b>Sistem Informasi Jaringan Listrik</b><br>
      Kabupaten Barito Timur
    </div>
    <img src="assets/img/logo-pln.png">
  </div>
  <div class="header-controls">
    <select id="kec"></select>
    <button onclick="openForm()">+ Input Data</button>
  </div>
</header>

<div id="map"></div>

<div id="popup">
  <div class="popup-head">
    <span id="popTitle">Detail</span>
    <span onclick="closePop()">âœ–</span>
  </div>
  <div class="popup-body" id="popBody"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API="https://script.google.com/macros/s/AKfycbyk8HcsTeNaVdPSb58pvFszIXD0szhorV9VX5xk5tW4PyZH1VF2x0EGVoaAhPGoPs2k/exec";

const map=L.map('map',{minZoom:9,maxZoom:19}).setView([-1.95,115.15],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const layer=L.layerGroup().addTo(map);

/* LOAD KECAMATAN */
fetch(API+'?action=master').then(r=>r.json()).then(j=>{
  const s=document.getElementById('kec');
  s.innerHTML='<option value="">-- Pilih Kecamatan --</option>';
  [...new Set(j.data.map(d=>d.kecamatan))].forEach(k=>{
    s.innerHTML+=`<option>${k}</option>`;
  });
});

/* DEMO POLYLINE */
document.getElementById('kec').onchange=e=>{
  layer.clearLayers();
  if(!e.target.value)return;
  const poly=L.polyline([[-1.95,115.12],[-1.96,115.15],[-1.97,115.18]],
    {color:'#2563eb',weight:4}).addTo(layer);
  poly.on('click',()=>showDetail());
  map.fitBounds(poly.getBounds());
};

function showDetail(){
  document.getElementById('popTitle').innerText='Detail Jaringan';
  document.getElementById('popBody').innerHTML=
    `<b>Status:</b> Draft<br>Data siap ditampilkan`;
  openPop();
}

/* FORM INPUT */
function openForm(){
  document.getElementById('popTitle').innerText='Input Data';
  document.getElementById('popBody').innerHTML=`
    <label>Kecamatan</label><input id="f_kec">
    <label>Desa</label><input id="f_desa">
    <label>Jumlah Tiang</label><input id="f_tiang" type="number">
    <button style="margin-top:10px" onclick="save()">Simpan</button>`;
  openPop();
}

function save(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'save_data',
      payload:{
        kecamatan:f_kec.value,
        desa_kelurahan:f_desa.value,
        jumlah_tiang:Number(f_tiang.value),
        kode_kecamatan:f_kec.value.substring(0,2).toUpperCase()
      }
    })
  })
  .then(r=>r.json())
  .then(j=>alert(j.message+'\nID: '+j.id_jaringan));
}

function openPop(){popup.style.display='block'}
function closePop(){popup.style.display='none'}
</script>
</body>
</html>
